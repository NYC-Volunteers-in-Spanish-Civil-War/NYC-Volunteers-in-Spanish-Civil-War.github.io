<!DOCTYPE html>
<html lang="en">
  <head>
    {{ ckeditor.load() }}
    <style>
      h1 {
	  text-align: center;
	  color: white;
      }
      .status {
	  text-align: right;
      }
      #the_form {
	  border: 1px solid black;
	  background-color: silver;
      }
      #cke_ckeditor {
	  border-radius: 15px;
	  padding: 15px;
	  background-color: #ededed;
      }
      #iframe_container {
	  width: 100%;
	  height: 10in;;
      }
      #iframe {
	  border-radius:15px;
      }
      .thumbnail {
	  width: 1.25in;
	  vertical-align: middle;
      }
      .img_uploader_div {
	  border: 1px solid black;
	  background-color: #ededed;
      }
      .img_uploader_div hr {
	  display: block;
      }
      .img_uploader_div ul {
	  padding: 0;
	  list-style-type: none;
	  height: 460px;
	  margin: 0;
	  width: 100%;
	  overflow-y: scroll;
      }
      .img_modifier {
	  display: inline-block;
      }
      .img_modifier * {
	  display: block;
      }
      .img_row {
	  overflow: scroll;
	  height: 100%;
	  position: absolute;
      }
    </style>
    <link rel="stylesheet" href="css/jquery-ui.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../js/jquery-ui.js"></script>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <script src="js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script>
      /* Handles form sanitization and proper upload behavior*/
      $(document).on("submit", "#main_form", function(event) {
	  event.preventDefault(); // to prevent default page reloading
	  //Trim trailing and leading spaces
	  $('input[type=text]').val(function () {
	      return this.value.trim();
	  });
	  //Make sure all fields are full
	  var empty_fields = false;
	  $('input[required]').each(function(){
              if ($(this).val() == ''){
		  empty_fields = true;
		  return;
              }
          });
	  if(empty_fields)
	      return false;
	  //A function to get local GET variables
	  var getURL = function getUrlVars() {
	      var vars = {};
	      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
		  vars[key] = value;
	      });
	      return vars;
	  };
	  CKEDITOR.instances.ckeditor.updateElement();

	  //Converts the images into a json_encoded list of base64 images and their captions
	  $('.img_uploader').each(function(){
	      var $el = $("#" +  $(this).attr('name'));
	      var array = $el.find('li').map(function(){
		  return { src: $(this).find('img').attr('src'),
			   caption: $(this).find('input').val()};
              }).get();
	      $("#" +  $(this).attr('name') + "_hidden").val(JSON.stringify(array));
	  });
	  //Send the data. If need be(New volunteer/Change name), reload the page with a new key.
          var dataString = $(this).serialize(); // to get the form data
          $.ajax({
	      type: "POST",
	      url: window.location.href,
	      data: dataString,
	      success: function(data, textStatus, xhr){
		  if(data.redirect)
		      window.location = data.redirect;
	      },
	      error: function(data, textStatus, xhr){
	      },
          });
      });
      //Open confirmation prompts for the git username and password, pass them to the server
      $(document).on("click", "#upload_changes", function(event){
	  event.preventDefault();
	  $.ajax({
	      type: "POST",
	      url: "/upload_changes",
	      data: {
		  action: 'changes_made'
	      },
	      success: function(result) {
		  $("#main_form").submit();
		  var username = prompt("Please enter your Github username:");
		  if(!username)
		      return;
		  var password = prompt("Please enter your Github password:");
		  if(!password)
		      return;
		  $.ajax({
		      type: "POST",
		      url: "/upload_changes",
		      data: {
			  action: 'push_changes',
			  user: username,
			  pass: password
		      },
		      success: function(result) {
			  alert("Changes pushed successfully. The live site should update in a few minutes.")
		      },
		      error: function(result) {
			  alert('Username or password was incorrect');
		      }
		  });
	      },
	      error: function(result) {
		  alert('No changes have been made');
	      }
	  });
      });
      //Passes a request to remove the current volunteer from the server. Goes back to the main page.
      $(document).on("click", "#delete", function(event){
	  event.preventDefault();
	  var confirm_delete = confirm("Are you sure you want to delete this volunteer's information?");
	  if(confirm_delete){
	      $.ajax({
		  type: "POST",
		  url: "/delete",
		  data: {
		      key: $("#volunteers").val()
		  },
		  success: function(){
		      $("#volunteers").val("");
		      $("#volunteer_select").submit();
		  }
	      })
	  }
      });
      //Handles removing an image from the server.
      $(document).on("click", ".remove_image", function(){
	  $.ajax({
	      type: "POST",
	      url: "/delete_image",
	      data: {
		  key: $("#volunteers").val(),
		  data: $(this).parent().parent().find('img').attr("src")
	      }
	  })
	  $(this).parent().parent().remove();
      });
      $(document).ready(function(){
	  //Change words to title case as you type in the Names.
	  $('.form_data').on("propertychange change click keyup input paste", function(){
	      $(this).val(function(){
		  return this.value.replace(/(?:^|\s)\w/g, function(match) {
		      return match.toUpperCase();
		  })
	      });
	  });
	  //Intercepts the image inputs, covnerts them to base64, adds them to this sessions images.
	  $(".img_uploader").change(function (){
	      var $out = $('#' + $(this).attr('name'));
	      for(var i = 0; i < this.files.length; i++){
		  var FR = new FileReader();
		  FR.addEventListener("load", function(e) {
		      $li = $('<li class="list-group-item px-4 saved_image"></li>');
		      $img = $('<img class="thumbnail">').attr("src", e.target.result);
		      $li.append($img);
		      $li.append(`
			<div class="img_modifier">
				<input type="text" class="caption" placeholder="Caption Text">
				<button type="button" class="remove_image">Remove Image</button>
		        </div>`);
		      $out.find('ul').append($li);
		  });
		  FR.readAsDataURL( this.files[i] );
	      }
	      $(this).val('');
	  });
      });
      //Refresh the preview button. Save the local changes, reload iframe.
      $(document).on("click", "#refresh_preview", function(event){
	  $("#main_form").submit();
	  $( '#iframe' ).attr( 'src', function ( i, val ) { return val; });
      })
      </script>
    <title>Volunteer Editor</title>
  </head>
  <body class="bg-dark">
    <h1>Volunteer Editor</h1>
    <div class="container-fluid p-4">
      <div id="the_form" class="col-12 mx-auto rounded p-4">
	<div class="row p-4 text-center">
	  <div class="col">
	    <form id="volunteer_select" method="GET" action="/">
	      <label for="volunteers"><h2>Select Volunteer: </h2></label>
	      <select id="volunteers" name="key" onchange="this.form.submit()">
		<option value="" default>New Volunteer  </option>
		{% for k, v in master_list.iteritems()|sort %}
		<option value="{{ k }}" {% if key==k %} selected {% endif %}>
		  {{ v.volunteer_fname ~ " " ~ v.volunteer_lname ~ " --- " ~ v.student_fname ~ " " ~ v.student_lname ~ " - "  ~ v.class }}
		  <span class="status"> [{{ v.status }}] </span>
		</option>
		{% endfor %}
	      </select>
	      {% if key %}
	      <input id="delete" name="delete" value="Delete Volunteer" type="submit"/>
	      {% endif %}
	    </form>
	  </div>
	</div>
	<div class="row p-4">
	  <form id="main_form" method="POST" action="" class="container-fluid" enctype=multipart/form-data>
	    <input type="hidden" name="key" value="{{key}}"/>
	    <div class="row p-4 text-center">
	      <div class="col-md-6">
		<h2>Student Information</h2>
		<label>First Name:</label>
		<input class="form_data" type="text" name="student_fname" value="{{ data.student_fname }}" required>
		<br/>
		<label>Last Name:</label>
		<input class="form_data" type="text" name="student_lname" value="{{ data.student_lname }}" required>
		<br/>
		<label>Class of:</label>
		<input type="number" name="class" value="{{ data.class }}" required>

	      </div>
	      <div class="col-md-6">
		<h2>Volunteer Information</h2>
		<label>First Name:</label>
		<input class="form_data" type="text" name="volunteer_fname" value="{{ data.volunteer_fname }}" required>
		<br/>
		<label>Last Name:</label>
		<input class="form_data" type="text" name="volunteer_lname" value="{{ data.volunteer_lname }}" required>
	      </div>
	    </div>
	    <div class="row p-4 text-center">
	      <div class="col-md-6">
		<label><h2>Editor</h2></label>
		<input class="btn btn-light" type=submit name="submit_type" value="Save Document"/>
		<button class="btn btn-light" id="upload_changes">Upload Changes</button>
		<td colspan=2><textarea name="ckeditor" id="ckeditor">{{ data.data }}</textarea></td>
		{{ ckeditor.config() }}
	      </div>
	      <div class="col-md-6">
		<h2>Image Upload</h2>
		<div class="row img_row">
		  <div id="volunteer_images" class="bg-light rounded col-md-6">
		    <h3>Images of Volunteer</h3>
		    <hr>
		    <input class="img_uploader" type="file" name="volunteer_images" id="volunteer_image_upload"  multiple>
		    <hr>
		    <input type="hidden" name="volunteer_images_hidden" id="volunteer_images_hidden">
		    <ul class="list-group list-group-flush">
		      {% for v in data.volunteer_images %}
	              <li class="list-group-item px-0 saved_image">
			<img class="thumbnail" src="{{ v.src }}">
			<div class="img_modifier">
			  <input type="text" class="caption" placeholder="Caption Text" value="{{ v.caption }}">
			  <button type="button" class="remove_image">Remove Image</button>
			</div>
		      </li>
		      {% endfor %}
		    </ul>
		  </div>
		  <div id="school_crests" class="bg-light rounded col-md-6">
		    <h3>School Crests</h3>
		    <hr>
		    <input class="img_uploader" type="file" name="school_crests" id="school_crest_upload"  multiple>
		    <hr>
		    <input type="hidden" name="school_crests_hidden" id="school_crests_hidden">
		    <ul class="list-group list-group-flush">
		      {% for v in data.school_crests %}
	              <li class="list-group-item px-0 saved_image">
			<img class="thumbnail" src="{{ v.src }}">
			<div class="img_modifier">
			  <input type="text" class="caption" placeholder="Caption Text" value="{{ v.caption }}">
			  <button type="button" class="remove_image">Remove Image</button>
			</div>
		      </li>
		      {% endfor %}
		    </ul>
		  </div>
		</div>
	      </div>
	    </div>
	    <div class="row p-4">
	      <div class="col-md-3">
		<h2>Preview</h2>
	      </div>
	      <div class="col-md-3">
		<button id="refresh_preview" class="btn btn-light">Refresh Preview</button>
		<a class="btn btn-light" role="button" target="_blank" href="http://127.0.0.1:8000/archive/#{{ key }}">Preview On Full Page</a>
	      </div>
	    </div>
	    <div class="row p-4">
	      <div id="iframe_container">
		<iframe id="iframe" src="http://127.0.0.1:8000/archive/#{{ key }}" width="100%" height="100%"></iframe>
	      </div>
	    </div>
	  </form>
	</div>
      </div>
    </div>
  </body>
</html>
