<!doctype html>
<head>
  {{ ckeditor.load() }}
  <style>
    #the_form {
	width: 100%;
	margin: 0 auto;
	max-width: 1600px;
    }
    table {
	width:100%;
	table-layout: fixed;
    }
    #volunteer_select {
	display: inline-block;
    }
    td > * {
	display: inline-block;
    }
    td {
	text-align: center;
	margin: 0 auto;
	position: relative;
    }
    #iframe_container {
	width: 100%;
	height: 10in;;
    }
    .thumbnail {
	width: 1.5in;
	vertical-align: middle;
    }
    .img_uploader_div {
	valign: top;
    }
    .img_uploader_div hr {
	display: block;
    }
    .img_modifier {
	display: inline-block;
    }
    .img_modifier *{
	display: block;
    }
  </style>
  <link rel="stylesheet" href="css/jquery-ui.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <script>
    /* Handles form sanitization and proper upload behavior*/
    $(document).on("submit", "#main_form", function(event) {
	event.preventDefault(); // to prevent default page reloading
	//Trim trailing and leading spaces
	$('input[type=text]').val (function () {
	    return this.value.trim();
	})
	//Make sure all fields are full
	var empty_fields = false;
	$('input[required]').each(function(){
            if ($(this).val() == ''){
		empty_fields = true;
		return;
            }
        });
	if(empty_fields)
	    return false;
	//A function to get local GET variables
	var getURL = function getUrlVars() {
	    var vars = {};
	    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
		vars[key] = value;
	    });
	    return vars;
	}
	CKEDITOR.instances.ckeditor.updateElement();

	//Converts the images into a json_encoded list of base64 images and their captions
	$('.img_uploader').each(function(){
	    var $el = $("#" +  $(this).attr('name'));
	    var array = $el.find('li').map(function(){
		return { src: $(this).find('img').attr('src'),
			 caption: $(this).find('input').val()};
            }).get();
	    $("#" +  $(this).attr('name') + "_hidden").val(JSON.stringify(array));
	});
	//Send the data. If need be(New volunteer/Change name), reload the page with a new key.
        var dataString = $(this).serialize(); // to get the form data
        $.ajax({
	    type: "POST",
	    url: window.location.href,
	    data: dataString,
	    success: function(){
		var d = getURL();
		var val = $('input[name=volunteer_lname]').val() + "_" + $('input[name=volunteer_fname]').val();
		val = val.replace(/ /g, "+");
		if(!d['key'] || (d['key'] != val)){
		    window.location.href = "http://127.0.0.1:5000/?key=" + val;
		}
	    },
	    error: function(e){
	    }
        });
	//Set document status in select if page hasn't been reloaded (PUBLISHED -> MODIFIED)
	$('#volunteer_select option:selected').text($('#volunteer_select option:selected').text().replace("[PUBLISHED]", "[MODIFIED]"))
    });
    //Open confirmation prompts for the git username and password, pass them to the server
    $(document).on("click", "#upload_changes", function(event){
	event.preventDefault();
	$.ajax({
	    type: "POST",
	    url: "/upload_changes",
	    data: {
		action: 'changes_made'
	    },
	    success: function(result) {
		$("#main_form").submit();
		var username = prompt("Please enter your Github username:");
		if(!username)
		    return;
		var password = prompt("Please enter your Github password:");
		if(!password)
		    return;
		$.ajax({
		    type: "POST",
		    url: "/upload_changes",
		    data: {
			action: 'push_changes',
			user: username,
			pass: password
		    },
		    success: function(result) {
			alert("Changes pushed successfully. The live site should update in a few minutes.")
		    },
		    error: function(result) {
			alert('Username or password was incorrect');
		    }
		});
	    },
	    error: function(result) {
		alert('No changes have been made');
	    }
	});
    });
    //Passes a request to remove the current volunteer from the server. Goes back to the main page.
    $(document).on("click", "#delete", function(event){
	event.preventDefault();
	var confirm_delete = confirm("Are you sure you want to delete this volunteer's information?");
	if(confirm_delete){
	    $.ajax({
		type: "POST",
		url: "/delete",
		data: {
		    key: $("#volunteers").val()
		},
		success: function(){
		    $("#volunteers").val("");
		    $("#volunteer_select").submit();
		}
	    })
	}
    });
    //Handles removing an image from the server.
    $(document).on("click", ".remove_image", function(){
	$.ajax({
	    type: "POST",
	    url: "/delete_image",
	    data: {
		key: $("#volunteers").val(),
		data: $(this).parent().parent().find('img').attr("src")
	    }
	})
	$(this).parent().parent().remove();
    });
    $(document).ready(function(){
	//Change words to title case as you type in the Names.
	$('.form_data').on("propertychange change click keyup input paste", function(){
	    $(this).val(function(){
		return this.value.replace(/(?:^|\s)\w/g, function(match) {
		    return match.toUpperCase();
		})
	    });
	});
	//Intercepts the image inputs, covnerts them to base64, adds them to this sessions images.
	$(".img_uploader").change(function (){
	    var $out = $('#' + $(this).attr('name'));
	    for(var i = 0; i < this.files.length; i++){
		var FR = new FileReader();
		FR.addEventListener("load", function(e) {
		    $li = $('<li class="saved_image"></li>');
		    $img = $('<img class="thumbnail">').attr("src", e.target.result);
		    $li.append($img);
		    $li.append(`
			<div class="img_modifier">
				<input type="text" class="caption" placeholder="Caption Text">
				<button type="button" class="remove_image">Remove Image</button>
		        </div>`);
		    $out.append($li)
		});
		FR.readAsDataURL( this.files[i] );
	    }
	    $(this).val('');
	});
    });
    //Refresh the preview button. Save the local changes, reload iframe.
    $(document).on("click", "#refresh_preview", function(event){
	$("#main_form").submit();
	$( '#iframe' ).attr( 'src', function ( i, val ) { return val; });
    })
  </script>

  <title>Volunteer Editor</title>
</head>
<body>
  <div id="the_form">
    <form id="volunteer_select" method="GET" action="/">
      <table>
	<tr>
	  <td>
	    <label for="volunteers"><h2>Select Volunteer: </h2></label>
	    <select id="volunteers" name="key" onchange="this.form.submit()">
	      <option value="" default>New Volunteer  </option>
	      {% for k, v in mega_data.iteritems()|sort %}
	      <option value="{{ k }}" {% if key==k %} selected {% endif %}>
		{{v.volunteer_fname ~ " " ~ v.volunteer_lname ~ " --- " ~ v.student_fname ~ " " ~ v.student_lname ~ " - "  ~ v.class ~ "  [" ~ v.status ~ "]" }}
	      </option>
	      {% endfor %}
	    </select>
	    {% if key %}
	      <input id="delete" name="delete" value="Delete Volunteer" type="submit"/>
	    {% endif %}
	  </td>
	</tr>
      </table>
    </form>

    <form id="main_form" method="POST" action="" enctype=multipart/form-data>
      <table>
	<tr>
	  <td colspan=2><h2>Student Information</h2></td>
	  <td colspan=2><h2>Volunteer Information</h2></td>
	</tr>
	<tr>
	  <td>First Name:</td>
	  <td><input class="form_data" type="text" name="student_fname" value="{{ data.student_fname }}" required></td>

	  <td>First Name:</td>
	  <td><input class="form_data" type="text" name="volunteer_fname" value="{{ data.volunteer_fname }}" required></td>
	</tr>
	<tr>
	  <td>Last Name:</td>
	  <td><input class="form_data" type="text" name="student_lname" value="{{ data.student_lname }}" required></td>

	  <td>Last Name:</td>
	  <td><input class="form_data" type="text" name="volunteer_lname" value="{{ data.volunteer_lname }}" required></td>
	</tr>
	<tr>
	  <td>Class of:</td>
	  <td><input type="number" name="class" value="{{ data.class }}" required></td>
	</tr>
	<tr>
	  <td><h2>Editor</h2></td>
	  <td>
	    <input type=submit name="submit_type" value="Save Document"/>
	    <button id="upload_changes">Upload Changes</button>
	  </td>
	  <td colspan=2><h2>Image Upload</h2></td>
	</tr>

	<tr>
	  <td colspan=2><textarea name="ckeditor" id="ckeditor">{{ data.data }}</textarea></td>
	  {{ ckeditor.config() }}
	  <td id="volunteer_images" valign="top" class="img_uploader_div">
	    <h3>Images of Volunteer</h3>
	    <hr>
	    <input class="img_uploader" type="file" name="volunteer_images" id="volunteer_image_upload"  multiple>
	    <hr>
	    <br>
	    <input type="hidden" name="volunteer_images_hidden" id="volunteer_images_hidden">
	    {% for v in data.volunteer_images %}
	      <li>
		<img class="thumbnail" src="{{ v.src }}">
		<div class="img_modifier">
		  <input type="text" class="caption" placeholder="Caption Text" value="{{ v.caption }}">
		  <button type="button" class="remove_image">Remove Image</button>
		</div>
	      </li>
	    {% endfor %}
	  </td>
	  <td id="school_crests" valign="top" class="img_uploader_div">
	    <h3>School Crests</h3>
	    <hr>
	    <input class="img_uploader" type="file" name="school_crests" id="school_crest_upload"  multiple>
	    <hr>
	    <br>
	    <input type="hidden" name="school_crests_hidden" id="school_crests_hidden">
	    {% for v in data.school_crests %}
	      <li>
		<img class="thumbnail" src="{{ v.src }}">
		<div class="img_modifier">
		  <input type="text" class="caption" placeholder="Caption Text" value="{{ v.caption }}">
		  <button type="button" class="remove_image">Remove Image</button>
		</div>
	      </li>
	    {% endfor %}
	  </td>
	</tr>
	<tr>
	  <td><h2>Preview</h2></td>
	  <td>
	    <button id="refresh_preview">Refresh Preview</button>
	    <button><a target="_blank" href="http://127.0.0.1:8000/archive/#{{ key }}">Preview On Full Page</a></button>
	  </td>
	</tr>
	<tr>
	  <td colspan=4>
	    <div id="iframe_container">
	      <iframe id="iframe" src="http://127.0.0.1:8000/archive/#{{ key }}" width="100%" height="100%"></iframe>
	    </div>
	  </td>
	</tr>
      </table>
    </form>
  </div>
</body>
